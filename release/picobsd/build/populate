#!/bin/sh
#
#	$Id: populate,v 1.6 1998/09/26 17:27:18 abial Exp $
#

. ../Version

pwd=`pwd`

echo "-> Populating MFS tree..."
cd ../${TYPE}/mfs.tree
make
if [ X"${NO_DEVFS}" != X"" ]
then
	make devnodes
fi
if [ "X$?" != "X0" ]
then
	echo "-> ERROR while making \"${TYPE}\" hierarchy in /mnt..."
	echo "-> Aborting $0"
	exit 10
fi
if [ "${TYPE}" = "router" ]
then
	cat ../lang/mfs.rc.${LANGUAGE}| \
		sed -e "s/@VER@/${VER}/g" > \
		/mnt/etc/oinit.rc
else
	cat ../lang/mfs.rc.${LANGUAGE} | \
		sed -e "s/@VER@/${VER}/g" > \
		/mnt/etc/rc
	cp login.conf /mnt/etc/login.conf
	cp ../lang/reboot.${LANGUAGE} /mnt/stand/reboot
	ln -f /mnt/stand/reboot /mnt/stand/shutdown
	cat ../lang/README.${LANGUAGE} | \
		sed -e "s/@VER@/${VER}/g" > \
		/mnt/README
fi
cp ../lang/update.${LANGUAGE} /mnt/stand/update
if [ "${TYPE}" = "dial" ]
then
	cp ../lang/login.${LANGUAGE} /mnt/stand/login
	cp ../lang/dialup.${LANGUAGE} /mnt/stand/dialup
	(cd ../../help;\
	rm -rf tmp_hlp;\
	mkdir tmp_hlp;\
	for i in `ls *.hlp.${LANGUAGE}`;\
	do \
		cp $i tmp_hlp/`basename $i .hlp.${LANGUAGE}`;\
	done;\
	cd tmp_hlp;\
	ar -cru help.a *;\
	cp help.a /mnt/help.a)
elif [ "${TYPE}" != "router" ]
then
	cp ../../build/kvm_kernel.db /mnt/var/db/kvm_kernel.db
	rm ../../build/kvm_kernel.db
fi

echo "-> Making and installing crunch1..."
cd ../crunch1
make "SRC=${SRC}" && make install 2>&1 >/dev/null
if [ "X$?" != "X0" ]
then
	echo "-> ERROR while building ../${TYPE}/crunch1..."
	echo "-> Aborting $0"
	exit 10
fi

cd ${pwd}

echo "-> Preparing kernel symbols list..."
if [ ! -f ../tools/dumpnlist/dumpnlist ]
then
	(cd ../tools/dumpnlist; make)
fi
(echo "-> Fixing permissions"; cd /mnt; chown -R root *)
