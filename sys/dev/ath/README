Things that need doing!

* RIFS? Do I care about supporting RIFS?

* Fast Frames? Do I care about supporting FF here, or is it done via suitable
  evilness in net80211?

* A-MPDU aggregation?
  + how many pending A-MPDU frames per hardware TXQ? As many as needed? One?

* Software retransmit when aggregation is enabled
  + Whether doing A-MPDU or not
  + Support rate updates and lookup on a retry; maybe a slower rate
    is needed?

* Send BAR when needed
  + after TX failure
  + when else?

* DELBA - ie, downgrade existing packets in the SWQ
  + What about stuff in the HWQ?

* 20<->2040 mode change?
  + part of this project or not?
  + right now packets are simply flushed; why not just re-prod them into
    the software TXQ ?

Things that need investigating!


* How should channel scanning be handled? Right now it's causing both a HW TXQ
  and SW TXQ / node flush; this means the BAW will need to be slid along. Eek.

* When a node is flushed (but not being deleted) should the BAW also be updated?
  I don't think it is right now and this could be incorrect.

* LOR between the net80211 node lock and the txqs

lock order reversal:
 1st 0x80a02738 ath1_txq1 (ath1_txq1) @ /data/freebsd/mips/if_ath_tx/src/sys/dev/ath/if_ath.c:4154
 2nd 0xc086c6cc ath1_node_lock (ath1_node_lock) @ /data/freebsd/mips/if_ath_tx/src/sys/net80211/ieee80211_node.c:1702
KDB: stack backtrace:
db_trace_thread+30 (?,?,?,?) ra 8038aacc sp c7713a88 sz 24
db_trace_self+1c (?,?,?,?) ra 80074c3c sp c7713aa0 sz 24
80074c08+34 (?,?,?,?) ra 801ce304 sp c7713ab8 sz 416
kdb_backtrace+44 (?,?,?,?) ra 801e5dc0 sp c7713c58 sz 24
801e5d8c+34 (?,?,?,?) ra 801e6a04 sp c7713c70 sz 32
witness_checkorder+954 (?,?,?,?) ra 80186ea0 sp c7713c90 sz 88
_mtx_lock_flags+c4 (?,?,?,?) ra 8029885c sp c7713ce8 sz 48
ieee80211_free_node+40 (?,?,?,?) ra 80079c80 sp c7713d18 sz 48
ath_tx_freebuf+68 (?,?,?,?) ra 80079d2c sp c7713d48 sz 40
ath_tx_default_comp+34 (?,?,?,?) ra 8007d664 sp c7713d70 sz 24
8007d2b0+3b4 (?,?,?,?) ra 8007df3c sp c7713d88 sz 64
8007deb4+88 (?,?,?,?) ra 801dc284 sp c7713dc8 sz 48
801dc19c+e8 (?,?,?,?) ra 801dcd4c sp c7713df8 sz 56
taskqueue_thread_loop+60 (?,?,?,?) ra 8016c2c4 sp c7713e30 sz 40
fork_exit+a8 (?,?,?,?) ra 80383210 sp c7713e58 sz 40
fork_trampoline+10 (?,?,?,?) ra 0 sp c7713e80 sz 0
pid 0

And another LOR:

lock order reversal:
 1st 0xc08316cc ath0_node_lock (ath0_node_lock) @ /data/freebsd/mips/if_ath_tx/src/sys/net80211/ieee80211_node.c:1702
 2nd 0x80a03738 ath0_txq1 (ath0_txq1) @ /data/freebsd/mips/if_ath_tx/src/sys/dev/ath/if_ath_tx.c:1854
KDB: stack backtrace:
db_trace_thread+30 (?,?,?,?) ra 8038ab6c sp c7bf9798 sz 24
db_trace_self+1c (?,?,?,?) ra 80074c3c sp c7bf97b0 sz 24
80074c08+34 (?,?,?,?) ra 801ce3a4 sp c7bf97c8 sz 416
kdb_backtrace+44 (?,?,?,?) ra 801e5e60 sp c7bf9968 sz 24
801e5e2c+34 (?,?,?,?) ra 801e6aa4 sp c7bf9980 sz 32
witness_checkorder+954 (?,?,?,?) ra 80186f40 sp c7bf99a0 sz 88
_mtx_lock_flags+c4 (?,?,?,?) ra 80085fc4 sp c7bf99f8 sz 48
ath_tx_node_flush+8c (?,?,?,?) ra 800860d0 sp c7bf9a28 sz 48
ath_tx_tid_cleanup+10 (?,?,?,?) ra 8007c654 sp c7bf9a58 sz 24
8007c5fc+58 (?,?,?,?) ra 80298318 sp c7bf9a70 sz 32
802981fc+11c (?,?,?,?) ra 80298914 sp c7bf9a90 sz 24
ieee80211_free_node+58 (?,?,?,?) ra 8029a110 sp c7bf9aa8 sz 48
8029a078+98 (?,?,?,?) ra 8029c044 sp c7bf9ad8 sz 40
ieee80211_sta_join+20c (?,?,?,?) ra 8028e720 sp c7bf9b00 sz 40
8028e688+98 (?,?,?,?) ra 80290148 sp c7bf9b28 sz 48
802900e4+64 (?,?,?,?) ra 80290948 sp c7bf9b58 sz 72
802903f4+554 (?,?,?,?) ra 80292604 sp c7bf9ba0 sz 128
ieee80211_ioctl+2c8 (?,?,?,?) ra 802b9e84 sp c7bf9c20 sz 48
in_control+1c8 (?,?,?,?) ra 802514d8 sp c7bf9c50 sz 88
ifioctl+13cc (?,?,80aaada0,80dda900) ra 801ee8c0 sp c7bf9ca8 sz 144
soo_ioctl+3b0 (?,?,?,?) ra 801e91c4 sp c7bf9d38 sz 40
kern_ioctl+23c (?,?,?,?) ra 801e936c sp c7bf9d60 sz 64
ioctl+130 (?,?,?,?) ra 8037eb6c sp c7bf9da0 sz 56
trap+8a4 (?,?,?,?) ra 80376fec sp c7bf9dd8 sz 168
MipsUserGenException+10c (?,?,?,40818e20) ra 0 sp c7bf9e80 sz 0
pid 1510

Fixed issues:

* Recursive TXQ lock on interface destruction:

  - Fixed by only locking the TXQ in ath_tx_node_flush if the TXQ
    isn't already locked by us.

drian-home-mips# ifconfig wlan0 destroy
ath1: ath_tx_node_flush: called
ar5212StopDmaReceive: dma failed to stop in 10ms
AR_CR=0x00000024
AR_DIAG_SW=0x42000020
wlan0: [00:1b:b1:58:f6:f0] send station disassociate (reason 8)
ath1: ath_tx_node_flush: called
panic: _mtx_lock_sleep: recursed on non-recursive mutex ath1_txq1 @ /data/freebsd/mips/if_ath_tx/src/sys/dev/ath/if_ath_tx.c:1854

KDB: enter: panic
[ thread pid 0 tid 100028 ]
Stopped at      kdb_enter+0x4c: lui     at,0x804c
db> bt
Tracing pid 0 tid 100028 td 0x80762900
db_trace_thread+30 (?,?,?,?) ra 80072de0 sp c7717748 sz 24
80072ccc+114 (0,?,ffffffff,?) ra 8007239c sp c7717760 sz 32
80072014+388 (?,?,?,?) ra 80072520 sp c7717780 sz 168
db_command_loop+70 (?,?,?,?) ra 80074be4 sp c7717828 sz 24
80074af0+f4 (?,?,?,?) ra 801cdf78 sp c7717840 sz 424
kdb_trap+104 (?,?,?,?) ra 8037ee00 sp c77179e8 sz 40
trap+bd8 (?,?,?,?) ra 80376d50 sp c7717a10 sz 168
MipsKernGenException+134 (0,4,803f6b90,109) ra 801ce204 sp c7717ab8 sz 200
kdb_enter+4c (?,?,?,?) ra 80196e38 sp c7717b80 sz 24
panic+f4 (?,80a0274c,803ddea4,73e) ra 80186c9c sp c7717b98 sz 40
_mtx_lock_sleep+68 (?,?,?,?) ra 80186f14 sp c7717bc0 sz 32
_mtx_lock_flags+138 (?,?,?,?) ra 80085f74 sp c7717be0 sz 48
ath_tx_node_flush+70 (?,?,?,?) ra 80086028 sp c7717c10 sz 40
ath_tx_tid_cleanup+10 (?,?,?,?) ra 8007c654 sp c7717c38 sz 24
8007c5fc+58 (?,?,?,?) ra 80298278 sp c7717c50 sz 32
8029815c+11c (?,?,?,?) ra 80298958 sp c7717c70 sz 24
ieee80211_free_node+13c (?,?,?,?) ra 80079c80 sp c7717c88 sz 48
ath_tx_freebuf+68 (?,?,?,?) ra 80079d2c sp c7717cb8 sz 40
ath_tx_default_comp+34 (?,?,?,?) ra 80079ef0 sp c7717ce0 sz 24
80079e3c+b4 (?,?,?,?) ra 0 sp c7717cf8 sz 0
pid 0
