# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2024 The FreeBSD Foundation
#
# This software was developed by Cybermancer Infosec <bofh@FreeBSD.org>
# under sponsorship from the FreeBSD Foundation.
#
# CI Makefile for aarch64.
#
QEMU_ARCH=aarch64
QEMU_DEVICES=-device ahci,id=ahci
QEMU_EXTRA_PARAM=-bios /usr/local/share/u-boot/u-boot-qemu-arm64/u-boot.bin -cpu cortex-a57
QEMU_MAX_CPU_COUNT=64
QEMU_MAX_MEM_SIZE=64

# NOTE: Nothing should be changed below this line unless explicitly required.

ci-buildworld-aarch64: ci-buildworld .PHONY

ci-buildkernel-aarch64: ci-buildkernel .PHONY

ci-buildimage-aarch64: ci-buildimage .PHONY

.if ${MACHINE} == "arm64" && ( !defined(USE_QEMU) || empty(USE_QEMU) )
portinstall-aarch64: portinstall-pkg .PHONY
.if !exists(/usr/local/share/u-boot/u-boot-bhyve-arm64/u-boot.bin)
	env ASSUME_ALWAYS_YES=yes pkg install sysutils/u-boot-bhyve-arm64
.endif

ci-runtest-aarch64: .PHONY
	/usr/sbin/bhyvectl --vm=${TEST_VM_NAME} --destroy || true
	expect -c "set timeout ${TIMEOUT_EXPECT}; \
		spawn /usr/bin/timeout -k 60 ${TIMEOUT_VM} /usr/sbin/bhyve \
		-c ${PARALLEL_JOBS} -m ${VM_MEM_SIZE} \
		-s 0:0,hostbridge \
		-s 2:0,virtio-blk,${CIDISK} \
		-s 3:0,virtio-blk,${META_TAR} \
		${BHYVE_EXTRA_DISK_PARAM} \
		-o console=stdio \
		-o bootrom=/usr/local/share/u-boot/u-boot-bhyve-arm64/u-boot.bin \
		${TEST_VM_NAME}; \
		expect { eof }"
	/usr/sbin/bhyvectl --vm=${TEST_VM_NAME} --destroy
.else
portinstall-aarch64: portinstall-pkg .PHONY
.if !exists(/usr/local/share/u-boot/u-boot-qemu-arm64/u-boot.bin)
	env ASSUME_ALWAYS_YES=yes pkg install sysutils/u-boot-qemu-arm64
.endif

ci-runtest-aarch64: ci-runtest-qemu .PHONY
.endif
