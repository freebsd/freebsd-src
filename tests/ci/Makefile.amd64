# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2024 The FreeBSD Foundation
#
# This software was developed by Cybermancer Infosec <bofh@FreeBSD.org>
# under sponsorship from the FreeBSD Foundation.
#
# CI Makefile for amd64.
#
QEMU_ARCH=x86_64
QEMU_MACHINE=q35
QEMU_MAX_CPU_COUNT=256
QEMU_MAX_MEM_SIZE=128

portinstall-amd64: portinstall-pkg .PHONY
	@true

# NOTE: Nothing should be changed below this line unless explicitly required.

ci-buildworld-amd64: ci-buildworld .PHONY

ci-buildkernel-amd64: ci-buildkernel .PHONY

ci-buildimage-amd64: ci-buildimage .PHONY

.if ${MACHINE} == "amd64" && ( !defined(USE_QEMU) || empty(USE_QEMU) )
ci-runtest-amd64: .PHONY
	/usr/sbin/bhyvectl --vm=${TEST_VM_NAME} --destroy || true
	expect -c "set timeout ${TIMEOUT_EXPECT}; \
		spawn /usr/bin/timeout -k 5s 30s /usr/sbin/bhyveload \
		-c stdio -m ${VM_MEM_SIZE} -d ${CIDISK} ${TEST_VM_NAME}; \
		expect { eof }; \
		exit [lindex [wait] 3]"
	expect -c "set timeout ${TIMEOUT_EXPECT}; \
		spawn /usr/bin/timeout -k 60 ${TIMEOUT_VM} /usr/sbin/bhyve \
		-c ${PARALLEL_JOBS} -m ${VM_MEM_SIZE} -A -H -P \
		-s 0:0,hostbridge \
		-s 1:0,lpc \
		-s 2:0,virtio-blk,${CIDISK} \
		-s 3:0,virtio-blk,${META_TAR} \
		${BHYVE_EXTRA_DISK_PARAM} \
		-l com1,stdio \
		${TEST_VM_NAME}; \
		expect { eof }"
	/usr/sbin/bhyvectl --vm=${TEST_VM_NAME} --destroy
.else
ci-runtest-amd64: ci-runtest-qemu .PHONY
.endif
